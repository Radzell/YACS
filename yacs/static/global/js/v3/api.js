// Generated by CoffeeScript 1.3.1
(function() {
  var API, Collection, Model, api;

  Model = (function() {

    Model.name = 'Model';

    function Model(attrs) {
      this.attrs = attrs;
      if (this.attrs == null) {
        this.attrs = {};
      }
      this.id = this.attrs.id;
    }

    Model.prototype.get = function(name, defvalue) {
      return this.attrs[name] || defvalue;
    };

    Model.prototype.set = function(name, value) {
      return this.attrs[name] = value;
    };

    Model.prototype.set_attributes = function(attrs) {
      return $.extend(this.attrs, attrs);
    };

    Model.prototype.replace_attributes = function(attrs) {
      this.attrs = $.extend({}, attrs);
      return this.id = this.attrs.id;
    };

    Model.prototype.refresh = function(options) {
      var self, success;
      options = options || {};
      success = options.success || $.noop;
      self = this;
      return $.ajax($.extend({
        url: this.get('url')
      }, options, {
        success: function(data) {
          self.replace_attributes(data.result);
          return success(self);
        }
      }));
    };

    return Model;

  })();

  Collection = (function() {

    Collection.name = 'Collection';

    function Collection(url) {
      this.url = url;
      this.id_map = {};
      this.data = [];
    }

    Collection.prototype.attr = function(name) {
      var item;
      return [
        (function() {
          var _i, _len, _ref, _results;
          _ref = this.data;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            item = _ref[_i];
            _results.push(item[name]);
          }
          return _results;
        }).call(this)
      ];
    };

    Collection.prototype.add = function(item) {
      this.data.push(item);
      return this.id_map[item.id] = item;
    };

    Collection.prototype.clear = function() {
      this.slice(0);
      return this.id_map = {};
    };

    Collection.prototype.get = function(id) {
      return this.id_map[id];
    };

    Collection.prototype.refresh = function(options) {
      var self, success, url;
      options = options || {};
      success = options.success;
      self = this;
      url = options.url || this.url;
      return $.ajax($.extend({
        url: url
      }, options, {
        success: function(data) {
          var item, _i, _len, _ref;
          self.data.splice(0, self.length);
          _ref = data.result;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            item = _ref[_i];
            self.add(item);
          }
          return success(self);
        }
      }));
    };

    return Collection;

  })();

  API = (function() {

    API.name = 'API';

    function API() {
      this.base_url = '/api/4/';
      this.filter = '';
    }

    API.prototype.url = function(object, id) {
      if (id != null) {
        return this.base_url + object + '/' + id + '/';
      } else {
        return this.base_url + object + '/';
      }
    };

    API.prototype.get = function(url, success, error) {
      return $.ajax({
        url: url,
        type: 'GET',
        data: this.filter,
        dataType: 'json',
        cache: true,
        success: function(data) {
          var collection, x;
          if (data.success) {
            if (_.isArray(data.result)) {
              collection = new Collection(url);
              [
                (function() {
                  var _i, _len, _ref, _results;
                  _ref = data.result;
                  _results = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    x = _ref[_i];
                    _results.push(collection.add(new Model(x, url + x.id + '/')));
                  }
                  return _results;
                })()
              ];
              return success(collection);
            } else {
              return success(new Model(data.result, url));
            }
          } else {
            return error(data, null);
          }
        },
        error: function(xhr, txtStatus, exception) {
          return error(null, exception);
        }
      });
    };

    API.prototype.filter = function(query) {
      return this;
    };

    API.prototype.semesters = function(success, error) {
      return this.get(this.url('semesters'), success, error);
    };

    API.prototype.departments = function(success, error) {
      return this.get(this.url('departments'), success, error);
    };

    API.prototype.courses = function(success, error) {
      return this.get(this.url('courses'), success, error);
    };

    API.prototype.sections = function(success, error) {
      return this.get(this.url('sections'), success, error);
    };

    API.prototype.conflicts = function(success, error) {
      return this.get(this.url('conflicts'), success, error);
    };

    return API;

  })();

  window.api = api = new API;

}).call(this);
